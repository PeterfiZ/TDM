<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA & Mobile meta tags -->
    <meta name="theme-color" content="#2563eb"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <title>Antibiotikum TDM Kalkul√°tor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">
                üß¨ TDM Kalkul√°tor
            </h1>
            <p class="text-gray-600 text-center mb-2">Therapeutic Drug Monitoring - Gentamicin, Amikacin, Vancomicin, Voriconazole</p>
            <div class="text-center mb-8">
                <p class="text-xs text-gray-500">¬© 2025 Dr. P√©terfi Zolt√°n | Verzi√≥ 2.1.0</p>
            </div>
            
            <!-- Patient Data Section -->
            <div class="grid md:grid-cols-3 gap-8 mb-8">
                <div class="bg-blue-50 rounded-xl p-6">
                    <h2 class="text-xl font-semibold text-blue-800 mb-4">üë§ Beteg adatok</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sz√ºlet√©si √©v</label>
                            <input type="number" id="birthYear" placeholder="1980" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tests√∫ly (kg)</label>
                            <input type="number" id="weight" placeholder="70" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Magass√°g (cm)</label>
                            <input type="number" id="height" placeholder="170" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nem</label>
                            <select id="gender" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="male">F√©rfi</option>
                                <option value="female">N≈ë</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sz√©rum kreatinin (Œºmol/L)</label>
                            <input type="number" id="creatinine" placeholder="88" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <button onclick="calculateGFR()" class="w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        GFR sz√°m√≠t√°s (CKD-EPI)
                    </button>
                    
                    <div id="gfrResult" class="mt-4 p-3 bg-white rounded-lg border hidden">
                        <div class="text-sm text-gray-600">Sz√°m√≠tott GFR:</div>
                        <div id="gfrValue" class="text-lg font-semibold text-blue-600"></div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Vagy adja meg a GFR √©rt√©ket (mL/min/1.73m¬≤)</label>
                        <input type="number" id="manualGFR" placeholder="90" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dial√≠zis t√≠pusa</label>
                        <select id="dialysisType" onchange="updateDialysisInfo()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="none">Nincs dial√≠zis</option>
                            <option value="hd">HD - Hemodial√≠zis</option>
                            <option value="pd">PD - Peritone√°lis dial√≠zis</option>
                            <option value="crrt">CRRT - Folyamatos vesep√≥tl√≥ kezel√©s</option>
                        </select>
                    </div>
                    
                    <div id="dialysisInfo" class="mt-4 p-3 bg-orange-50 rounded-lg border hidden">
                        <div class="text-sm text-orange-800"></div>
                    </div>
                </div>
                
                <!-- Drug Selection -->
                <div class="bg-green-50 rounded-xl p-6">
                    <h2 class="text-xl font-semibold text-green-800 mb-4">üíä Gy√≥gyszer kiv√°laszt√°sa</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Gy√≥gyszer</label>
                            <select id="antibiotic" onchange="updateDrugInfo()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="gentamicin">Gentamicin</option>
                                <option value="amikacin">Amikacin</option>
                                <option value="vancomycin">Vancomycin</option>
                                <option value="voriconazole">Voriconazole</option>
                            </select>
                        </div>
                        
                        <div id="drugInfo" class="bg-white rounded-lg p-4 border">
                            <div class="text-sm font-medium text-gray-700 mb-2">Gentamicin</div>
                            <div class="text-xs text-gray-600">
                                ‚Ä¢ C√©lszint: 5-10 mg/L (cs√∫cs), <2 mg/L (v√∂lgy)<br>
                                ‚Ä¢ Felez√©si id≈ë: 2-3 √≥ra<br>
                                ‚Ä¢ Nefrotoxikus, ototoxikus
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Indik√°ci√≥ s√∫lyoss√°ga</label>
                            <select id="severity" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="mild">Enyhe fert≈ëz√©s</option>
                                <option value="moderate">K√∂zepes fert≈ëz√©s</option>
                                <option value="severe">S√∫lyos fert≈ëz√©s</option>
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="calculateInitialDose()" class="w-full mt-4 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">
                        Kezd≈ë d√≥zis sz√°m√≠t√°s
                    </button>
                </div>

                <!-- Initial Dose Result Column -->
                <div id="initialDoseResultColumn" class="bg-cyan-50 rounded-xl p-6 hidden">
                    <h2 class="text-xl font-semibold text-cyan-800 mb-4">üìä Kezd≈ë D√≥zis Javaslat</h2>
                    <div id="initialDoseContent" class="space-y-3 text-sm"></div>
                </div>
            </div>
            
            <!-- TDM Section -->
            <div class="bg-purple-50 rounded-xl p-6 mb-8">
                <h2 class="text-xl font-semibold text-purple-800 mb-4">üìä TDM Sz√°m√≠t√°s (V√∂lgyszint alap√∫)</h2>
                
                <div class="grid md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jelenlegi d√≥zis (mg)</label>
                        <input type="number" id="dose" placeholder="240" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">V√∂lgyszint (mg/L)</label>
                        <input type="number" id="troughLevel" step="0.1" placeholder="1.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jelenlegi d√≥zisk√∂z (√≥ra)</label>
                        <input type="number" id="interval" placeholder="24" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Steady-state el√©rve?</label>
                        <select id="steadyState" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="yes">Igen (‚â•5 felez√©si id≈ë)</option>
                            <option value="no">Nem</option>
                        </select>
                    </div>
                </div>
                
                <div class="bg-blue-100 rounded-lg p-4 mb-4">
                    <h4 class="font-medium text-blue-800 mb-2">üìã Mintav√©teli √∫tmutat√≥:</h4>
                    <div class="text-sm text-blue-700">
                        <strong>Aminoglikozidok (Gentamicin, Amikacin):</strong> K√∂zvetlen√ºl a k√∂vetkez≈ë d√≥zis el≈ëtt (el≈ëz≈ë d√≥zis ut√°n 18-24 √≥r√°val)<br>
                        <strong>Vancomycin:</strong> 30 perccel a negyedik d√≥zis el≈ëtt<br>
                        <strong>Voriconazole:</strong> K√∂zvetlen√ºl a k√∂vetkez≈ë d√≥zis el≈ëtt (steady-state ut√°n, 5. nap)
                    </div>
                </div>
                
                <button onclick="calculateTroughBasedTDM()" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors font-medium">
                    TDM Sz√°m√≠t√°s √©s D√≥zis Javaslat
                </button>
            </div>
            
            <!-- Results Section -->
            <div id="results" class="hidden">
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-yellow-50 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-4">üìà Farmakokinetikai param√©terek</h3>
                        <div id="pkResults" class="space-y-2 text-sm"></div>
                    </div>
                    
                    <div class="bg-red-50 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-red-800 mb-4">üí° D√≥zis javaslat</h3>
                        <div id="doseRecommendation" class="space-y-2 text-sm"></div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-xl p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‚ö†Ô∏è Klinikai megjegyz√©sek</h3>
                    <div id="clinicalNotes" class="text-sm text-gray-700"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const drugData = {
            gentamicin: {
                name: "Gentamicin",
                targetPeak: [5, 10],
                targetTrough: [0, 2],
                halfLife: 2.5,
                vd: 0.25,
                info: "‚Ä¢ C√©lszint: 5-10 mg/L (cs√∫cs), <2 mg/L (v√∂lgy)<br>‚Ä¢ D√≥zis: 5-7 mg/kg/nap<br>‚Ä¢ Felez√©si id≈ë: 2-3 √≥ra<br>‚Ä¢ Nefrotoxikus, ototoxikus",
                dosing: {mild: 5, moderate: 6, severe: 7},
                dialysis: {
                    hd: {dose: 2, interval: 48, postDialysis: true, info: "2 mg/kg dial√≠zis ut√°n, 48h-k√©nt"},
                    pd: {dose: 4, interval: 24, postDialysis: false, info: "4 mg/kg 24h-k√©nt"},
                    crrt: {dose: 3, interval: 24, postDialysis: false, info: "3 mg/kg 24h-k√©nt"}
                }
            },
            amikacin: {
                name: "Amikacin",
                targetPeak: [15, 30],
                targetTrough: [0, 5],
                halfLife: 2.5,
                vd: 0.25,
                info: "‚Ä¢ C√©lszint: 15-30 mg/L (cs√∫cs), <5 mg/L (v√∂lgy)<br>‚Ä¢ D√≥zis: 15 mg/kg/nap<br>‚Ä¢ Felez√©si id≈ë: 2-3 √≥ra<br>‚Ä¢ Nefrotoxikus, ototoxikus",
                dosing: {mild: 15, moderate: 15, severe: 15},
                dialysis: {
                    hd: {dose: 7.5, interval: 48, postDialysis: true, info: "7.5 mg/kg dial√≠zis ut√°n, 48h-k√©nt"},
                    pd: {dose: 12, interval: 24, postDialysis: false, info: "12 mg/kg 24h-k√©nt"},
                    crrt: {dose: 10, interval: 24, postDialysis: false, info: "10 mg/kg 24h-k√©nt"}
                }
            },
            vancomycin: {
                name: "Vancomycin",
                targetPeak: [20, 40],
                targetTrough: [10, 20],
                halfLife: 6,
                vd: 0.7,
                info: "‚Ä¢ C√©lszint: 20-40 mg/L (cs√∫cs), 10-20 mg/L (v√∂lgy)<br>‚Ä¢ D√≥zis: 15 mg/kg/12h<br>‚Ä¢ Felez√©si id≈ë: 4-8 √≥ra<br>‚Ä¢ Nefrotoxikus, Red Man Syndrome",
                dosing: {mild: 15, moderate: 15, severe: 15},
                dialysis: {
                    hd: {dose: 15, interval: 48, postDialysis: true, info: "15 mg/kg dial√≠zis ut√°n, 48h-k√©nt"},
                    pd: {dose: 15, interval: 24, postDialysis: false, info: "15 mg/kg 24h-k√©nt"},
                    crrt: {dose: 15, interval: 12, postDialysis: false, info: "15 mg/kg 12h-k√©nt"}
                }
            },
            voriconazole: {
                name: "Voriconazole",
                targetPeak: [2, 5.5],
                targetTrough: [1, 5.5],
                halfLife: 6,
                vd: 4.6,
                info: "‚Ä¢ C√©lszint: 1-5.5 mg/L (v√∂lgy)<br>‚Ä¢ D√≥zis: 6 mg/kg/12h iv, majd 4 mg/kg/12h<br>‚Ä¢ Felez√©si id≈ë: 6 √≥ra (nem-line√°ris)<br>‚Ä¢ Hepatotoxikus, vizu√°lis zavarok",
                dosing: {mild: 4, moderate: 4, severe: 6},
                dialysis: {
                    hd: {dose: 4, interval: 12, postDialysis: false, info: "4 mg/kg 12h-k√©nt (nem dialyz√°lhat√≥)"},
                    pd: {dose: 4, interval: 12, postDialysis: false, info: "4 mg/kg 12h-k√©nt (nem dialyz√°lhat√≥)"},
                    crrt: {dose: 4, interval: 12, postDialysis: false, info: "4 mg/kg 12h-k√©nt (nem dialyz√°lhat√≥)"}
                }
            }
        };

        const dialysisData = {
            hd: {
                name: "Hemodial√≠zis (HD)",
                info: "‚Ä¢ 3-4x/h√©t, 4 √≥ra<br>‚Ä¢ Dial√≠zis ut√°n d√≥zis sz√ºks√©ges<br>‚Ä¢ Jelent≈ës gy√≥gyszer-elt√°vol√≠t√°s",
                frequency: "3-4x/h√©t"
            },
            pd: {
                name: "Peritone√°lis dial√≠zis (PD)",
                info: "‚Ä¢ Folyamatos kezel√©s<br>‚Ä¢ M√©rs√©kelt gy√≥gyszer-elt√°vol√≠t√°s<br>‚Ä¢ Napi d√≥zisok sz√ºks√©gesek",
                frequency: "Folyamatos"
            },
            crrt: {
                name: "CRRT",
                info: "‚Ä¢ 24 √≥r√°s folyamatos kezel√©s<br>‚Ä¢ Jelent≈ës gy√≥gyszer-clearance<br>‚Ä¢ Gyakoribb d√≥zisok sz√ºks√©gesek",
                frequency: "Folyamatos"
            }
        };

        function calculateAge(birthYear) {
            const today = new Date();
            return today.getFullYear() - birthYear;
        }

        function calculateGFR() {
            const birthYear = parseInt(document.getElementById('birthYear').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            const gender = document.getElementById('gender').value;
            const creatinine = parseFloat(document.getElementById('creatinine').value);

            if (!birthYear || !weight || !height || !creatinine) {
                alert('K√©rem t√∂ltse ki az √∂sszes mez≈ët a GFR sz√°m√≠t√°shoz!');
                return;
            }

            const age = calculateAge(birthYear);
            const creatinineMgDl = creatinine / 88.4; // Convert Œºmol/L to mg/dL

            // CKD-EPI formula
            let kappa, alpha;
            if (gender === 'female') {
                kappa = 0.7;
                alpha = creatinineMgDl <= 0.7 ? -0.329 : -1.209;
            } else {
                kappa = 0.9;
                alpha = creatinineMgDl <= 0.9 ? -0.411 : -1.209;
            }

            const minCreatKappa = Math.min(creatinineMgDl / kappa, 1);
            const maxCreatKappa = Math.max(creatinineMgDl / kappa, 1);
            
            let gfr = 141 * Math.pow(minCreatKappa, alpha) * Math.pow(maxCreatKappa, -1.209) * Math.pow(0.993, age);
            
            if (gender === 'female') {
                gfr *= 1.018;
            }

            document.getElementById('gfrResult').classList.remove('hidden');
            document.getElementById('gfrValue').textContent = `${gfr.toFixed(1)} mL/min/1.73m¬≤`;
            document.getElementById('manualGFR').value = gfr.toFixed(1);
        }

        function updateDrugInfo() {
            const antibiotic = document.getElementById('antibiotic').value;
            const drug = drugData[antibiotic];
            document.getElementById('drugInfo').innerHTML = `
                <div class="text-sm font-medium text-gray-700 mb-2">${drug.name}</div>
                <div class="text-xs text-gray-600">${drug.info}</div>
            `;
        }

        function updateDialysisInfo() {
            const dialysisType = document.getElementById('dialysisType').value;
            const dialysisInfoDiv = document.getElementById('dialysisInfo');
            
            if (dialysisType === 'none') {
                dialysisInfoDiv.classList.add('hidden');
            } else {
                const dialysis = dialysisData[dialysisType];
                dialysisInfoDiv.classList.remove('hidden');
                dialysisInfoDiv.innerHTML = `
                    <div class="text-sm font-medium text-orange-800 mb-2">${dialysis.name}</div>
                    <div class="text-xs text-orange-700">${dialysis.info}</div>
                `;
            }
        }

        function calculateInitialDose() {
             const weight = parseFloat(document.getElementById('weight').value);
             const antibiotic = document.getElementById('antibiotic').value;
             const severity = document.getElementById('severity').value;
             const gfr = parseFloat(document.getElementById('manualGFR').value);
             const dialysisType = document.getElementById('dialysisType').value;
 
             if (!weight) {
                 alert('K√©rem adja meg a tests√∫lyt!');
                 return;
             }
 
             const drug = drugData[antibiotic];
             let resultHTML = '';
             
             resultHTML += `<div class="space-y-1">
                 <div><strong>Gy√≥gyszer:</strong> ${drug.name}</div>
                 <div><strong>Tests√∫ly:</strong> ${weight} kg</div>
             </div>`;
             
             // Check if dialysis is selected
             if (dialysisType !== 'none') {
                 const dialysisInfo = drug.dialysis[dialysisType];
                 const dialysisName = dialysisData[dialysisType].name;
                 const recommendedDose = Math.round(dialysisInfo.dose * weight);
                 
                 resultHTML += `<div class="mt-4 pt-4 border-t border-cyan-200">
                     <h4 class="font-semibold text-cyan-900">üè• DIAL√çZIS D√ìZIS (${dialysisName})</h4>
                     <ul class="list-disc list-inside mt-2 space-y-1">
                         <li><strong>D√≥zis:</strong> ${dialysisInfo.dose} mg/kg</li>
                         <li><strong>Sz√°m√≠t√°s:</strong> ${dialysisInfo.dose} mg/kg √ó ${weight} kg = ${recommendedDose} mg</li>
                         <li><strong>D√≥zisk√∂z:</strong> ${dialysisInfo.interval} √≥ra</li>
                     </ul>
                     ${dialysisInfo.postDialysis ? `<div class="mt-2 text-red-600 font-bold">‚ö†Ô∏è FONTOS: Dial√≠zis UT√ÅN adand√≥!</div>` : ''}
                 </div>`;
 
                 resultHTML += `<div class="mt-4 bg-blue-100 p-3 rounded-lg">
                     <div class="font-bold">üéØ JAVASOLT D√ìZIS:</div>
                     <div class="text-base">${recommendedDose} mg ${dialysisInfo.interval} √≥r√°nk√©nt</div>
                 </div>`;
 
                 resultHTML += `<div class="mt-4">
                     <div class="font-semibold">üìã Speci√°lis utas√≠t√°s:</div>
                     <div class="text-xs">${dialysisInfo.info}</div>
                 </div>`;
                 
             } else {
                 // Normal GFR-based dosing
                 if (!gfr) {
                     alert('K√©rem adja meg a GFR √©rt√©ket vagy v√°lasszon dial√≠zis t√≠pust!');
                     return;
                 }
                 
                 let baseDosePerKg = drug.dosing[severity];
                 const baseDose = baseDosePerKg * weight;
                 
                 // GFR adjustment
                 let gfrAdjustment = 1;
                 let gfrNote = "Norm√°l vesefunkci√≥";
                 if (gfr < 60) {
                     gfrAdjustment = 0.75;
                     gfrNote = "Enyhe veseel√©gtelens√©g";
                 }
                 if (gfr < 30) {
                     gfrAdjustment = 0.5;
                     gfrNote = "K√∂zepes veseel√©gtelens√©g";
                 }
                 if (gfr < 15) {
                     gfrAdjustment = 0.25;
                     gfrNote = "S√∫lyos veseel√©gtelens√©g";
                 }
 
                 const recommendedDose = Math.round(baseDose * gfrAdjustment);
                 
                 let interval = 24;
                 if (antibiotic === 'vancomycin') {
                     interval = gfr > 50 ? 12 : gfr > 20 ? 24 : 48;
                 } else {
                     interval = gfr > 60 ? 24 : gfr > 30 ? 36 : 48;
                 }
 
                 resultHTML += `<div class="mt-4 pt-4 border-t border-cyan-200">
                     <h4 class="font-semibold text-cyan-900">Sz√°m√≠t√°s</h4>
                     <ul class="list-disc list-inside mt-2 space-y-1">
                         <li><strong>Alapd√≥zis:</strong> ${baseDosePerKg} mg/kg</li>
                         <li><strong>Sz√°m√≠t√°s:</strong> ${baseDosePerKg} mg/kg √ó ${weight} kg = ${baseDose} mg</li>
                         <li><strong>GFR korrekci√≥ (${gfrNote}):</strong> ${baseDose} mg √ó ${gfrAdjustment} = ${recommendedDose} mg</li>
                     </ul>
                 </div>`;
 
                 resultHTML += `<div class="mt-4 bg-blue-100 p-3 rounded-lg">
                     <div class="font-bold">üéØ JAVASOLT D√ìZIS:</div>
                     <div class="text-base">${recommendedDose} mg ${interval} √≥r√°nk√©nt</div>
                 </div>`;
 
                 resultHTML += `<div class="mt-4 text-gray-600">
                     <strong>GFR:</strong> ${gfr} mL/min/1.73m¬≤ (${(gfrAdjustment * 100).toFixed(0)}% d√≥zis)
                 </div>`;
             }
 
             const resultColumn = document.getElementById('initialDoseResultColumn');
             const resultContent = document.getElementById('initialDoseContent');
             
             resultContent.innerHTML = resultHTML;
             resultColumn.classList.remove('hidden');
        }

        function calculateTroughBasedTDM() {
            const dose = parseFloat(document.getElementById('dose').value);
            const troughLevel = parseFloat(document.getElementById('troughLevel').value);
            const interval = parseFloat(document.getElementById('interval').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const gfr = parseFloat(document.getElementById('manualGFR').value);
            const antibiotic = document.getElementById('antibiotic').value;
            const steadyState = document.getElementById('steadyState').value;

            if (!dose || !troughLevel || !interval || !weight || !gfr) {
                alert('K√©rem t√∂ltse ki az √∂sszes mez≈ët!');
                return;
            }

            const drug = drugData[antibiotic];
            
            // Estimate pharmacokinetic parameters based on patient characteristics
            let estimatedKe;
            let estimatedVd = drug.vd * weight;
            
            // GFR-based elimination constant estimation
            if (antibiotic === 'vancomycin') {
                // Vancomycin clearance correlation with GFR
                const clearance = (0.689 * gfr + 3.66) / 60; // L/h
                estimatedKe = clearance / estimatedVd;
            } else if (antibiotic === 'voriconazole') {
                // Voriconazole has non-linear kinetics, hepatic metabolism
                // Clearance is not directly related to GFR
                const clearance = 4.6; // L/h (average adult clearance)
                estimatedKe = clearance / estimatedVd;
            } else {
                // Aminoglycosides clearance correlation with GFR
                const clearance = (1.73 * gfr / 100) * 1.2; // L/h
                estimatedKe = clearance / estimatedVd;
            }
            
            const estimatedHalfLife = 0.693 / estimatedKe;
            
            // Calculate what the peak would have been
            const estimatedPeak = troughLevel / Math.exp(-estimatedKe * interval);
            
            // Target levels
            const targetTroughMin = drug.targetTrough[0];
            const targetTroughMax = drug.targetTrough[1];
            const targetPeakMin = drug.targetPeak[0];
            const targetPeakMax = drug.targetPeak[1];
            
            // Dose adjustment calculation
            let newDose = dose;
            let newInterval = interval;
            let nextDoseDelay = 0; // Hours to wait before next dose
            let nextDoseRecommendation = "";
            let doseModificationReason = "";
            
            // If trough is outside target range, adjust dose
            if (troughLevel < targetTroughMin) {
                // Increase dose to achieve minimum trough
                const targetTrough = (targetTroughMin + targetTroughMax) / 2;
                newDose = Math.round(dose * (targetTrough / troughLevel));
                doseModificationReason = `Alacsony v√∂lgyszint miatt d√≥zis emel√©s: ${dose} mg ‚Üí ${newDose} mg`;
            } else if (troughLevel > targetTroughMax) {
                if (antibiotic === 'vancomycin' || antibiotic === 'voriconazole') {
                    // For vancomycin and voriconazole, prefer dose reduction
                    newDose = Math.round(dose * (targetTroughMax / troughLevel));
                    doseModificationReason = `Magas v√∂lgyszint miatt d√≥zis cs√∂kkent√©s: ${dose} mg ‚Üí ${newDose} mg`;
                } else {
                    // For aminoglycosides (gentamicin, amikacin)
                    const targetTrough = targetTroughMax; // Wait until trough drops to max acceptable level
                    
                    // Calculate time needed for trough to drop to target level
                    nextDoseDelay = Math.log(troughLevel / targetTrough) / estimatedKe;
                    
                    if (nextDoseDelay > 0) {
                        nextDoseRecommendation = `A k√∂vetkez≈ë d√≥zis a v√∂lgyszint ${targetTrough} mg/L al√° cs√∂kken√©s√©t k√∂vet≈ëen, ${Math.ceil(nextDoseDelay)} √≥ra m√∫lva adhat√≥`;
                    }
                    
                    // Determine if dose reduction or interval extension is better
                    const targetTroughFuture = targetTroughMax * 0.8; // Aim for 80% of max for future doses
                    const calculatedInterval = Math.log(dose / (estimatedVd * targetTroughFuture)) / estimatedKe;
                    
                    if (calculatedInterval <= 48) {
                        // Extend interval if reasonable
                        newInterval = Math.ceil(calculatedInterval / 12) * 12; // Round to nearest 12 hours
                        doseModificationReason = `Magas v√∂lgyszint miatt intervallum hosszabb√≠t√°s: ${interval}h ‚Üí ${newInterval}h (d√≥zis: ${dose} mg v√°ltozatlan)`;
                    } else {
                        // If interval would be too long, reduce dose instead
                        newDose = Math.round(dose * (targetTroughFuture / troughLevel));
                        doseModificationReason = `Magas v√∂lgyszint miatt d√≥zis cs√∂kkent√©s: ${dose} mg ‚Üí ${newDose} mg (intervallum: ${interval}h v√°ltozatlan)`;
                    }
                }
            }
            
            // Predict new levels with adjusted dosing
            const newPredictedTrough = (newDose / estimatedVd) * Math.exp(-estimatedKe * newInterval);
            const newPredictedPeak = (newDose / estimatedVd) * Math.exp(-estimatedKe * 1);

            // Display results
            document.getElementById('results').classList.remove('hidden');
            
            document.getElementById('pkResults').innerHTML = `
                <div><strong>Becs√ºlt elimin√°ci√≥s konstans:</strong> ${estimatedKe.toFixed(4)} h‚Åª¬π</div>
                <div><strong>Becs√ºlt felez√©si id≈ë:</strong> ${estimatedHalfLife.toFixed(1)} √≥ra</div>
                <div><strong>Becs√ºlt megoszl√°si t√©rfogat:</strong> ${(estimatedVd/weight).toFixed(2)} L/kg</div>
                <div><strong>Jelenlegi v√∂lgyszint:</strong> ${troughLevel.toFixed(1)} mg/L</div>
                <div><strong>Becs√ºlt cs√∫csszint:</strong> ${estimatedPeak.toFixed(1)} mg/L</div>
                <div><strong>√öj el≈ërejelzett v√∂lgyszint:</strong> ${newPredictedTrough.toFixed(1)} mg/L</div>
                <div><strong>√öj el≈ërejelzett cs√∫csszint:</strong> ${newPredictedPeak.toFixed(1)} mg/L</div>
            `;
            
            let recommendation = `<div><strong>Jelenlegi d√≥zis √©rt√©kel√©se:</strong></div>`;
            
            if (troughLevel >= targetTroughMin && troughLevel <= targetTroughMax) {
                recommendation += `<div class="text-green-600">‚úì V√∂lgyszint megfelel≈ë (${troughLevel.toFixed(1)} mg/L)</div>`;
            } else if (troughLevel < targetTroughMin) {
                recommendation += `<div class="text-red-600">‚ö† V√∂lgyszint alacsony (${troughLevel.toFixed(1)} mg/L) - hat√°stalans√°g kock√°zata</div>`;
            } else {
                recommendation += `<div class="text-red-600">‚ö† V√∂lgyszint magas (${troughLevel.toFixed(1)} mg/L) - toxicit√°s kock√°zata</div>`;
            }
            
            if (estimatedPeak >= targetPeakMin && estimatedPeak <= targetPeakMax) {
                recommendation += `<div class="text-green-600">‚úì Becs√ºlt cs√∫csszint megfelel≈ë (${estimatedPeak.toFixed(1)} mg/L)</div>`;
            } else if (estimatedPeak < targetPeakMin) {
                recommendation += `<div class="text-orange-600">‚ö† Becs√ºlt cs√∫csszint alacsony (${estimatedPeak.toFixed(1)} mg/L)</div>`;
            } else {
                recommendation += `<div class="text-red-600">‚ö† Becs√ºlt cs√∫csszint magas (${estimatedPeak.toFixed(1)} mg/L)</div>`;
            }
            
            recommendation += `<div class="mt-4"><strong>Javasolt m√≥dos√≠t√°s:</strong></div>`;
            
            // Special handling for elevated aminoglycoside trough levels
            if ((antibiotic === 'gentamicin' || antibiotic === 'amikacin') && troughLevel > targetTroughMax && nextDoseDelay > 0) {
                recommendation += `<div class="bg-red-100 border border-red-300 p-3 rounded-lg mb-3">`;
                recommendation += `<div class="font-bold text-red-800">‚ö†Ô∏è EMELKEDETT V√ñLGYSZINT - AZONNALI INT√âZKED√âS!</div>`;
                recommendation += `<div class="text-red-700 mt-2">`;
                recommendation += `<strong>K√∂vetkez≈ë d√≥zis id≈ëz√≠t√©se:</strong><br>`;
                recommendation += `${nextDoseRecommendation}<br><br>`;
                recommendation += `<strong>Ellen≈ërz√©s:</strong> V√∂lgyszint m√©r√©s ${Math.ceil(nextDoseDelay)} √≥ra m√∫lva<br>`;
                recommendation += `<strong>C√©l v√∂lgyszint:</strong> ‚â§${targetTroughMax} mg/L`;
                recommendation += `</div></div>`;
            }
            
            recommendation += `<div class="bg-blue-100 p-3 rounded-lg mt-2">`;
            
            if (doseModificationReason) {
                recommendation += `<div class="font-medium text-blue-800 mb-2">üìä D√≥zism√≥dos√≠t√°s r√©szletei:</div>`;
                recommendation += `<div class="text-blue-700 mb-3">${doseModificationReason}</div>`;
            }
            
            if (newDose !== dose || newInterval !== interval) {
                recommendation += `<strong>√öj d√≥zisbe√°ll√≠t√°s:</strong><br>`;
                recommendation += `<strong>D√≥zis:</strong> ${newDose} mg<br>`;
                recommendation += `<strong>D√≥zisk√∂z:</strong> ${newInterval} √≥ra<br>`;
                recommendation += `<strong>V√°rhat√≥ √∫j v√∂lgyszint:</strong> ${newPredictedTrough.toFixed(1)} mg/L<br><br>`;
                
                // Calculate dose per kg for reference
                const dosePerKg = (newDose / weight).toFixed(1);
                recommendation += `<strong>D√≥zis tests√∫lyra vet√≠tve:</strong> ${dosePerKg} mg/kg`;
            } else if (nextDoseDelay === 0) {
                recommendation += `<strong>Jelenlegi d√≥zis megtarthat√≥</strong><br>`;
                recommendation += `K√∂vetkez≈ë TDM: 3-5 nap m√∫lva`;
            }
            
            recommendation += `</div>`;
            
            document.getElementById('doseRecommendation').innerHTML = recommendation;
            
            // Clinical notes
            const dialysisType = document.getElementById('dialysisType').value;
            let notes = `<div><strong>${drug.name} specifikus megjegyz√©sek:</strong></div>`;
            notes += `<div class="mt-2">‚Ä¢ C√©lszintek: V√∂lgy ${targetTroughMin}-${targetTroughMax} mg/L</div>`;
            
            // Dialysis-specific notes
            if (dialysisType !== 'none') {
                const dialysisInfo = drug.dialysis[dialysisType];
                const dialysisName = dialysisData[dialysisType].name;
                notes += `<div class="bg-orange-100 p-3 rounded-lg mt-3">`;
                notes += `<div class="font-medium text-orange-800">${dialysisName} specifikus megjegyz√©sek:</div>`;
                notes += `<div class="text-sm text-orange-700 mt-1">‚Ä¢ ${dialysisInfo.info}</div>`;
                
                if (dialysisType === 'hd') {
                    notes += `<div class="text-sm text-orange-700">‚Ä¢ Dial√≠zis napj√°n: sz√©rumszint m√©r√©s dial√≠zis el≈ëtt √©s ut√°n</div>`;
                    notes += `<div class="text-sm text-orange-700">‚Ä¢ K√∂vetkez≈ë d√≥zis csak dial√≠zis ut√°n!</div>`;
                } else if (dialysisType === 'crrt') {
                    notes += `<div class="text-sm text-orange-700">‚Ä¢ Folyamatos clearance miatt gyakoribb TDM sz√ºks√©ges</div>`;
                    notes += `<div class="text-sm text-orange-700">‚Ä¢ Sz≈±r≈ë csere ut√°n d√≥zis √∫jra√©rt√©kel√©se</div>`;
                } else if (dialysisType === 'pd') {
                    notes += `<div class="text-sm text-orange-700">‚Ä¢ Peritone√°lis clearance figyelembev√©tele</div>`;
                    notes += `<div class="text-sm text-orange-700">‚Ä¢ Peritonitis eset√©n d√≥zis n√∂vel√©s sz√ºks√©ges</div>`;
                }
                notes += `</div>`;
            }
            
            if (antibiotic === 'vancomycin') {
                notes += `<div>‚Ä¢ Vancomycin eset√©n a v√∂lgyszint alap√∫ d√≥zisbe√°ll√≠t√°s az els≈ëdleges</div>`;
                notes += `<div>‚Ä¢ AUC/MIC >400 el√©r√©se a c√©l s√∫lyos fert≈ëz√©sekben</div>`;
                notes += `<div>‚Ä¢ Red Man Syndrome elker√ºl√©se: ‚â•60 perc inf√∫zi√≥</div>`;
            } else if (antibiotic === 'voriconazole') {
                notes += `<div>‚Ä¢ Voriconazole: nem-line√°ris farmakokinetika</div>`;
                notes += `<div>‚Ä¢ CYP2C19 polimorfizmus befoly√°solja a clearance-t</div>`;
                notes += `<div>‚Ä¢ M√°jfunkci√≥ monitoroz√°sa (transzamin√°zok)</div>`;
                notes += `<div>‚Ä¢ Vizu√°lis zavarok gyakori mell√©khat√°s</div>`;
                notes += `<div>‚Ä¢ Gy√≥gyszer-interakci√≥k: CYP3A4 inhibitor</div>`;
                
                if (troughLevel > targetTroughMax) {
                    notes += `<div class="bg-yellow-100 border border-yellow-300 p-3 rounded-lg mt-3">`;
                    notes += `<div class="font-medium text-yellow-800">Emelkedett voriconazole v√∂lgyszint kezel√©se:</div>`;
                    notes += `<div class="text-sm text-yellow-700 mt-1">`;
                    notes += `‚Ä¢ D√≥zis cs√∂kkent√©s sz√ºks√©ges (>5.5 mg/L toxikus)<br>`;
                    notes += `‚Ä¢ M√°jfunkci√≥ ellen≈ërz√©se (ALT, AST, bilirubin)<br>`;
                    notes += `‚Ä¢ Vizu√°lis zavarok fokozott monitoroz√°sa<br>`;
                    notes += `‚Ä¢ Egy√©b CYP3A4 szubsztr√°tok d√≥zis√°nak fel√ºlvizsg√°lata<br>`;
                    notes += `‚Ä¢ K√∂vetkez≈ë TDM: 3-5 nap m√∫lva`;
                    notes += `</div></div>`;
                } else if (troughLevel < targetTroughMin) {
                    notes += `<div class="bg-orange-100 border border-orange-300 p-3 rounded-lg mt-3">`;
                    notes += `<div class="font-medium text-orange-800">Alacsony voriconazole v√∂lgyszint:</div>`;
                    notes += `<div class="text-sm text-orange-700 mt-1">`;
                    notes += `‚Ä¢ Ter√°pi√°s hat√°stalans√°g kock√°zata (<1 mg/L)<br>`;
                    notes += `‚Ä¢ CYP2C19 rapid metabolizer gyan√∫ja<br>`;
                    notes += `‚Ä¢ D√≥zis emel√©s vagy gyakoribb adagol√°s<br>`;
                    notes += `‚Ä¢ Compliance ellen≈ërz√©se<br>`;
                    notes += `‚Ä¢ Alternat√≠v antimikotikum m√©rlegel√©se`;
                    notes += `</div></div>`;
                }
            } else {
                notes += `<div>‚Ä¢ Aminoglikozidok: napi 1x adagol√°s prefer√°lt</div>`;
                notes += `<div>‚Ä¢ Post-antibiotikus hat√°s kihaszn√°l√°sa</div>`;
                notes += `<div>‚Ä¢ Ototoxicit√°s √©s nefrotoxicit√°s monitoroz√°sa</div>`;
                
                // Special notes for elevated aminoglycoside levels
                if (troughLevel > targetTroughMax) {
                    notes += `<div class="bg-yellow-100 border border-yellow-300 p-3 rounded-lg mt-3">`;
                    notes += `<div class="font-medium text-yellow-800">Emelkedett aminoglikozid v√∂lgyszint kezel√©se:</div>`;
                    notes += `<div class="text-sm text-yellow-700 mt-1">`;
                    notes += `‚Ä¢ D√≥zis kihagy√°sa am√≠g v√∂lgyszint ‚â§${targetTroughMax} mg/L<br>`;
                    notes += `‚Ä¢ Napi v√∂lgyszint ellen≈ërz√©s sz√ºks√©ges<br>`;
                    notes += `‚Ä¢ Vesefunkci√≥ √©s hall√°s monitoroz√°sa fokozottan<br>`;
                    notes += `‚Ä¢ Egy√©b nefrotoxikus szerek ker√ºl√©se<br>`;
                    notes += `‚Ä¢ Megfelel≈ë hidrat√°l√°s biztos√≠t√°sa`;
                    notes += `</div></div>`;
                }
            }
            
            if (steadyState === 'no') {
                notes += `<div class="text-orange-600 mt-2">‚ö† Steady-state m√©g nem √©rhet≈ë el - √≥vatos √©rtelmez√©s sz√ºks√©ges!</div>`;
            }
            
            if (troughLevel > targetTroughMax) {
                notes += `<div class="text-red-600 mt-2">‚ö† Magas v√∂lgyszint - azonnali d√≥zism√≥dos√≠t√°s sz√ºks√©ges!</div>`;
            }
            
            document.getElementById('clinicalNotes').innerHTML = notes;
        }

        // Initialize
        updateDrugInfo();
    </script>
    
    <footer class="text-center py-6 mt-8">
        <div class="bg-white rounded-xl shadow-lg p-4 max-w-md mx-auto">
            <p class="text-gray-600 text-sm">
                <strong>¬© 2025 Dr. P√©terfi Zolt√°n</strong>
            </p>
            <p class="text-xs text-gray-500 mt-1">
                TDM Kalkul√°tor v2.1.0 - Klinikai d√∂nt√©st√°mogat√°s
            </p>
            <p class="text-xs text-gray-400 mt-1">
                Minden jog fenntartva
            </p>
        </div>
    </footer>
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker sikeresen regisztr√°lva, scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker regisztr√°ci√≥ sikertelen: ', err);
                    });
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97299e8256a48888',t:'MTc1NTc3Mzk0Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
